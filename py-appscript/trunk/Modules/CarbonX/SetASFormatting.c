/* *	APPLESCRIPT FORMATTING *	SetASFormatting.cp * *	Copyright © 1998-2003 Marco Piovanelli *	All Rights Reserved * *	<marco - piovanelli -at- pobox - com> *	<http://www.merzwaren.com/snippets/> * * *	Modified by HAS, 2005 */static OSStatus BuildStyle ( const AERecord * inStyleRecord, STElement * ioStyle ){	AEKeyword	styleTags [ 7 ] ;	AEDescList	styleList ;	Str255		fontName ;	DescType	actualType ;	Size		actualSize ;	OSStatus	err ;	styleTags [ 0 ] = kAEBold ;	styleTags [ 1 ] = kAEItalic ;	styleTags [ 2 ] = kAEUnderline ;	styleTags [ 3 ] = kAEOutline ;	styleTags [ 4 ] = kAEShadow ;	styleTags [ 5 ] = kAECondensed ;	styleTags [ 6 ] = kAEExpanded ;	AEInitializeDesc ( & styleList ) ;	//	get font name	err = AEGetParamPtr ( inStyleRecord, pFont, typeText, & actualType, fontName + 1, 255, & actualSize ) ;	if ( err == noErr )	{		fontName [ 0 ] = actualSize ;		//	get font ID from name		ioStyle -> stFont = FMGetFontFamilyFromName ( fontName ) ;	}	else if ( err != errAEDescNotFound )	{		goto cleanup ;	}	//	get point size	err = AEGetParamPtr ( inStyleRecord, pPointSize, typeShortInteger, & actualType,		& ioStyle -> stSize, sizeof ( ioStyle -> stSize ), & actualSize ) ;	if ( ( err != noErr ) && ( err != errAEDescNotFound ) )	{		goto cleanup ;	}	//	get list of styles	err = AEGetParamDesc ( inStyleRecord, pTextStyles, typeAEList, & styleList ) ;	if ( err == noErr )	{		SInt32 itemCount ;		//	count QD styles		if ( ( err = AECountItems ( & styleList, & itemCount ) ) != noErr )		{			goto cleanup ;		}		ioStyle -> stFace = normal ;		//	walk the list		SInt32 itemIndex;		for ( itemIndex = 1 ; itemIndex <= itemCount ; itemIndex ++ )		{			AEKeyword keyword ;			AEKeyword styleTag ;			//	get nth item			if ( ( err = AEGetNthPtr ( & styleList, itemIndex, typeEnumerated, & actualType,				& keyword, & styleTag, sizeof ( styleTag ), & actualSize ) ) != noErr )			{				goto cleanup ;			}			//	identify style tag			int styleIndex;			for ( styleIndex = 0 ; styleIndex < 7 ; styleIndex ++ )			{				if ( styleTag == styleTags [ styleIndex ] )				{					//	set the corresponding bit in ioStyle -> stFace					ioStyle -> stFace |= ( 1 << styleIndex ) ;				}			}		}	}	else if ( err != errAEDescNotFound )	{		goto cleanup ;	}	//	get color	err = AEGetParamPtr ( inStyleRecord, pColor, typeRGBColor, & actualType,		& ioStyle -> stColor, sizeof ( ioStyle -> stColor ), & actualSize ) ;	if ( ( err != noErr ) && ( err != errAEDescNotFound ) )	{		goto cleanup ;	}	//	clear result code	err = noErr ;cleanup :	AEDisposeDesc ( & styleList ) ;	//	return result code	return err ;}extern pascal OSErr OSA_StyleDescToRec(AEDesc formatList, STHandle *sourceStyles){	AERecord			styleRecord ;	SInt32				formatCount ;	OSStatus			err ;	AEInitializeDesc ( & styleRecord ) ;		err = memFullErr ;	if ( *sourceStyles == 0 ) goto cleanup ;	//	sanity check: make sure the style table is big enough to	//	contain all the AppleScript styles	if ( GetHandleSize ( ( Handle ) *sourceStyles ) < kASNumberOfSourceStyles * sizeof ( STElement ) ) goto cleanup ;	//	lock the style table	HLock ( ( Handle ) *sourceStyles ) ;	//	count format list entries	if ( ( err = AECountItems ( & formatList, & formatCount ) ) != noErr )	{		goto cleanup ;	}	//	walk the format list	int styleIndex;	for ( styleIndex = 0 ;		  styleIndex < kASNumberOfSourceStyles ;		  styleIndex ++ )	{		AEKeyword formatKeyword ;		//	get nth style record		if ( ( err = AEGetNthDesc ( & formatList, styleIndex + 1, typeAERecord,			& formatKeyword, & styleRecord ) ) != noErr )		{			goto cleanup ;		}		//	add style to style table		if ( ( err = BuildStyle ( & styleRecord, ( ** sourceStyles ) + styleIndex ) ) != noErr )		{			goto cleanup ;		}		//	get rid of style record		AEDisposeDesc ( & styleRecord ) ;	}	//	unlock source styles	HUnlock ( ( Handle ) *sourceStyles ) ;	//	clear result code	err = noErr ;cleanup :	AEDisposeDesc ( & styleRecord ) ;	//	return result code	return ( OSErr ) err ;}